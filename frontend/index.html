<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Set dark theme as permanent -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakWise AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track { background: #1e293b; } /* Dark scrollbar track */
        #chat-window::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        #chat-window::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .pulse-red {
            animation: pulse-red-animation 1.5s infinite;
        }
        @keyframes pulse-red-animation {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-slate-900 flex flex-col h-screen transition-colors duration-300">

    <header class="bg-slate-800 shadow-md w-full p-4 flex justify-center items-center border-b border-slate-700">
        <h1 class="text-2xl font-bold text-slate-200 text-center">SpeakWise AI üó£Ô∏è‚ú®</h1>
    </header>

    <main class="flex-1 flex flex-col p-4 md:p-8 overflow-hidden">
        <div id="chat-window" class="flex-1 p-6 space-y-6 overflow-y-auto">
            <!-- Initial AI Welcome Message -->
            <div class="flex justify-start">
                <div class="text-slate-200 bg-slate-700 rounded-2xl p-4 max-w-xl">
                    <p>Hello! Press the "Start Recording" button and say something to begin.</p>
                </div>
            </div>
             <!-- Messages will be added here -->
        </div>

        <div id="controls" class="flex-shrink-0 pt-6 text-center">
            <p id="status" class="text-slate-400 mb-4 h-6">Press the button to start recording.</p>
            <button id="record-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">
                Start Recording
            </button>
        </div>
    </main>

    <script>
        // --- DOM Elements ---
        const chatWindow = document.getElementById('chat-window');
        const statusEl = document.getElementById('status');
        const recordBtn = document.getElementById('record-btn');

        // --- MediaRecorder Setup ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            recordBtn.addEventListener('click', () => {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
        } else {
            statusEl.textContent = "Sorry, your browser doesn't support audio recording.";
            recordBtn.disabled = true;
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    isRecording = true;
                    
                    statusEl.textContent = "Recording... Click to stop.";
                    recordBtn.textContent = "Stop Recording";
                    recordBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    recordBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'pulse-red');

                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        addAudioPlayer(audioUrl);
                        uploadAudio(audioBlob); 

                        stream.getTracks().forEach(track => track.stop());
                    };
                })
                .catch(err => {
                    console.error("Error accessing microphone:", err);
                    statusEl.textContent = "Error: Could not access microphone.";
                });
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            statusEl.textContent = "Processing...";
            recordBtn.textContent = "Start Recording";
            recordBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'pulse-red');
            recordBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            recordBtn.disabled = true;
        }
        
        function uploadAudio(audioBlob) {
            const formData = new FormData();
            const fileName = `recording_${Date.now()}.webm`;
            formData.append("audio_file", audioBlob, fileName);

            addThinkingIndicator("Transcribing and analyzing your speech...");

            fetch('/api/transcribe', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                }
                return response.json();
            })
            .then(data => {
                const thinkingIndicator = document.getElementById('thinking-indicator');
                if (thinkingIndicator) thinkingIndicator.remove();
                
                addUserMessage(data.transcript);
                // **UPDATED**: Pass the audio data from the response
                addAiResponse(data.feedback, data.audio);
            })
            .catch(error => {
                console.error('Error:', error);
                statusEl.textContent = `Error: ${error.message}`;
                const thinkingIndicator = document.getElementById('thinking-indicator');
                if (thinkingIndicator) thinkingIndicator.remove();
            })
            .finally(() => {
                recordBtn.disabled = false;
                statusEl.textContent = "Press the button to start recording.";
            });
        }

        // --- UI Functions ---
        function addUserMessage(text) {
            const messageHtml = `
                <div class="flex justify-end">
                    <div class="bg-slate-600 text-white rounded-2xl p-4 max-w-xl">
                        <p>${text}</p>
                    </div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        }

        function addAudioPlayer(audioUrl) {
            const audioHtml = `
                <div class="flex justify-end">
                    <div class="bg-slate-600 rounded-2xl p-4 max-w-xl">
                        <audio controls src="${audioUrl}"></audio>
                    </div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', audioHtml);
            scrollToBottom();
        }

        function addThinkingIndicator(text = "Processing audio...") {
            const thinkingHtml = `
                <div id="thinking-indicator" class="flex justify-start">
                    <div class="text-slate-200 bg-slate-700 rounded-2xl p-4 max-w-xl">
                        <p class="italic">${text}</p>
                    </div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', thinkingHtml);
            scrollToBottom();
        }

        // **UPDATED**: This function now receives the Base64 audio string
        function addAiResponse(feedback, audioBase64) {
            const analysisItems = feedback.detailedAnalysis.map(item => `<li>${item}</li>`).join('');
            const aiMessageHtml = `
                <div class="flex justify-start">
                    <div class="text-slate-200 bg-slate-700 rounded-2xl p-4 max-w-xl space-y-4">
                        <p>${feedback.conversationalReply}</p>
                        <div class="border-t border-slate-600 pt-4">
                            <h3 class="font-bold text-sm text-slate-400 mb-2">Suggestion:</h3>
                            <p class="italic">‚Äú${feedback.phraseSuggestion}‚Äù</p>
                        </div>
                        <div class="border-t border-slate-600 pt-4">
                            <h3 class="font-bold text-sm text-slate-400 mb-2">Analysis:</h3>
                            <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">${analysisItems}</ul>
                        </div>
                    </div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', aiMessageHtml);
            scrollToBottom();

            // **NEW**: Play the high-quality audio from the backend
            playAudioFromBase64(audioBase64);
        }
        
        // **NEW**: This function decodes the Base64 string and plays the audio
        function playAudioFromBase64(base64String) {
            const byteCharacters = atob(base64String);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const audioBlob = new Blob([byteArray], { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            const audio = new Audio(audioUrl);
            audio.play();
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>
</html>
