<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakWise AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track { background: #f1f5f9; }
        #chat-window::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        #chat-window::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .pulse-red {
            animation: pulse-red-animation 1.5s infinite;
        }
        @keyframes pulse-red-animation {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col h-screen">

    <header class="bg-white shadow-md w-full p-4">
        <h1 class="text-2xl font-bold text-slate-800 text-center">SpeakWise AI üó£Ô∏è‚ú®</h1>
    </header>

    <main class="flex-1 flex flex-col p-4 md:p-8 overflow-hidden">
        <div id="chat-window" class="flex-1 bg-white rounded-xl shadow-inner p-6 overflow-y-auto space-y-6">
            <div class="ai-message flex gap-3">
                <div class="bg-slate-700 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center font-bold">AI</div>
                <div class="text-slate-800 bg-slate-50 rounded-lg p-4 max-w-xl">
                    <p>Hello! Press the "Start Recording" button and say something to begin.</p>
                </div>
            </div>
        </div>

        <div id="controls" class="flex-shrink-0 pt-6 text-center">
            <p id="status" class="text-slate-500 mb-4 h-6">Press the button to start recording.</p>
            <button id="record-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105">
                Start Recording
            </button>
        </div>
    </main>

    <script>
        // --- DOM Elements ---
        const chatWindow = document.getElementById('chat-window');
        const statusEl = document.getElementById('status');
        const recordBtn = document.getElementById('record-btn');

        // --- MediaRecorder Setup ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // Check if the browser supports the necessary APIs
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            console.log("getUserMedia supported.");

            recordBtn.addEventListener('click', () => {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });

        } else {
            statusEl.textContent = "Sorry, your browser doesn't support audio recording.";
            recordBtn.disabled = true;
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    isRecording = true;
                    
                    // Update UI
                    statusEl.textContent = "Recording... Click to stop.";
                    recordBtn.textContent = "Stop Recording";
                    recordBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    recordBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'pulse-red');

                    // Clear previous recording chunks
                    audioChunks = [];

                    // Collect audio data
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    // Handle the stop event
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        // For now, let's just create a playable link to test it
                        const audioUrl = URL.createObjectURL(audioBlob);
                        addUserMessage("Recording finished. Ready to process.");
                        addAudioPlayer(audioUrl); // Let's add a player to hear our recording
                        addThinkingIndicator();

                        // In the next step, we will upload the audioBlob instead
                        // uploadAudio(audioBlob); 

                        // Stop the microphone track
                        stream.getTracks().forEach(track => track.stop());
                    };
                })
                .catch(err => {
                    console.error("Error accessing microphone:", err);
                    statusEl.textContent = "Error: Could not access microphone.";
                });
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;

            // Update UI
            statusEl.textContent = "Processing...";
            recordBtn.textContent = "Start Recording";
            recordBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'pulse-red');
            recordBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            recordBtn.disabled = true; // Disable button while processing
        }
        
        // --- UI Functions ---
        function addUserMessage(text) {
            const messageHtml = `
                <div class="user-message flex justify-end gap-3">
                    <div class="text-slate-800 bg-blue-50 rounded-lg p-4 max-w-xl">
                        <p>${text}</p>
                    </div>
                    <div class="bg-blue-600 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center font-bold">YOU</div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        }

        // **NEW**: A temporary function to let us hear our recording
        function addAudioPlayer(audioUrl) {
            const audioHtml = `
                <div class="user-message flex justify-end gap-3">
                    <div class="text-slate-800 bg-blue-50 rounded-lg p-4 max-w-xl">
                        <audio controls src="${audioUrl}"></audio>
                    </div>
                    <div class="bg-blue-600 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center font-bold">YOU</div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', audioHtml);
            scrollToBottom();
             recordBtn.disabled = false; // Re-enable button after processing
        }

        function addThinkingIndicator() {
            const thinkingHtml = `
                <div id="thinking-indicator" class="ai-message flex gap-3">
                    <div class="bg-slate-700 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center font-bold">AI</div>
                    <div class="text-slate-800 bg-slate-50 rounded-lg p-4 max-w-xl">
                        <p class="italic">Thinking...</p>
                    </div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', thinkingHtml);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>
</html>