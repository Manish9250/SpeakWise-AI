<script>

    
        
        // **NEW**: This function handles uploading the audio file.
        function uploadAudio(audioBlob) {
            const formData = new FormData();
            // We give the file a name, including the timestamp to make it unique
            const fileName = `recording_${Date.now()}.webm`;
            formData.append("audio_file", audioBlob, fileName);

            addUserMessage("You sent an audio recording.");
            addThinkingIndicator();

            fetch('/api/transcribe', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log("Success:", data);
                // Here is where we will eventually receive and display the transcript
                // For now, let's just log the success message
                
                // Remove the "Thinking..." indicator
                const thinkingIndicator = document.getElementById('thinking-indicator');
                if (thinkingIndicator) thinkingIndicator.remove();

                // Re-enable the button for the next recording
                recordBtn.disabled = false;
                statusEl.textContent = "Press the button to start recording.";
            })
            .catch(error => {
                console.error('Error:', error);
                statusEl.textContent = "Error uploading file. Please try again.";
                recordBtn.disabled = false;
            });
        }

        // --- UI Functions ---
        function addUserMessage(text) {
            const messageHtml = `
                <div class="user-message flex justify-end gap-3">
                    <div class="text-slate-800 bg-blue-50 rounded-lg p-4 max-w-xl">
                        <p>${text}</p>
                    </div>
                    <div class="bg-blue-600 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center font-bold">YOU</div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        }

        function addThinkingIndicator() {
            const thinkingHtml = `
                <div id="thinking-indicator" class="ai-message flex gap-3">
                    <div class="bg-slate-700 text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center font-bold">AI</div>
                    <div class="text-slate-800 bg-slate-50 rounded-lg p-4 max-w-xl">
                        <p class="italic">Processing audio...</p>
                    </div>
                </div>
            `;
            chatWindow.insertAdjacentHTML('beforeend', thinkingHtml);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>